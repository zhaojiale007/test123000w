<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàëÁöÑÂØºËà™È°µ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg-color: #ffffff;
            --text-color: #1f2329;
            --subtext-color: #646a73;
            --primary-color: #0070f3;
            --border-color: #e1e4e8;
            --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.12);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 900px;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }
        header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: var(--card-bg-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }
        .card h2 {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .item-list {
            list-style: none;
            padding: 0;
            flex-grow: 1;
        }
        .item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .item:hover {
            background-color: var(--bg-color);
        }
        .item a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            flex-grow: 1;
        }
        .item .icon {
            font-size: 1.2em;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }
        .item .actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: var(--subtext-color);
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .item:hover .actions button {
            opacity: 1;
        }
        .add-form {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .add-form input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        .add-form button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .clipboard-text {
            word-break: break-all;
            flex-grow: 1;
            padding-right: 10px;
        }
        #auth-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="page-title">Ê≠£Âú®Âä†ËΩΩ...</h1>
    </header>

    <main class="grid-container">
        <section id="links-card" class="card">
            <h2>ÂØºËà™ÈìæÊé•</h2>
            <ul id="link-list" class="item-list"></ul>
            <form id="add-link-form" class="add-form">
                <input type="text" id="link-name" placeholder="ÂêçÁß∞" required>
                <input type="url" id="link-url" placeholder="https://..." required>
                <button type="submit">Ê∑ªÂä†</button>
            </form>
        </section>

        <section id="clipboard-card" class="card">
            <h2>Ââ™Ë¥¥Êùø</h2>
            <ul id="clipboard-list" class="item-list"></ul>
            <form id="add-clip-form" class="add-form">
                <input type="text" id="clip-text" placeholder="Ë¶ÅÊöÇÂ≠òÁöÑÊñáÊú¨" required>
                <button type="submit">Ê∑ªÂä†</button>
            </form>
        </section>
    </main>
</div>

<div id="auth-modal">
    <div class="modal-content">
        <h3>ÈúÄË¶ÅË∫´‰ªΩÈ™åËØÅ</h3>
        <input type="text" id="auth-user" placeholder="Áî®Êà∑Âêç">
        <input type="password" id="auth-pass" placeholder="ÂØÜÁ†Å">
        <button id="auth-submit">Á°ÆËÆ§</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- State & DOM Elements ---
    let appData = { title: '', links: [], clipboard: [] };
    const pageTitle = document.getElementById('page-title');
    const linkList = document.getElementById('link-list');
    const clipboardList = document.getElementById('clipboard-list');
    
    const authModal = document.getElementById('auth-modal');
    const authUser = document.getElementById('auth-user');
    const authPass = document.getElementById('auth-pass');
    
    let credentials = null; // Store credentials for the session
    let actionQueue = []; // Queue for actions that need authentication

    // --- Authentication ---
    function getAuthHeader() {
        if (!credentials) return null;
        return 'Basic ' + btoa(`${credentials.user}:${credentials.pass}`);
    }

    function requestAuth(action) {
        actionQueue.push(action);
        authModal.style.display = 'flex';
    }
    
    document.getElementById('auth-submit').addEventListener('click', () => {
        if (authUser.value && authPass.value) {
            credentials = { user: authUser.value, pass: authPass.value };
            authModal.style.display = 'none';
            authUser.value = '';
            authPass.value = '';
            // Run all queued actions
            while(actionQueue.length > 0) {
                actionQueue.shift()();
            }
        }
    });

    // --- Data Fetching and Saving ---
    async function loadData() {
        const authHeader = getAuthHeader();
        if (!authHeader) {
            requestAuth(loadData);
            return;
        }

        try {
            const response = await fetch('/api/get-data', { headers: { 'Authorization': authHeader } });
            if (response.status === 401 || response.status === 403) {
                credentials = null; // Clear bad credentials
                requestAuth(loadData);
                return;
            }
            if (!response.ok) throw new Error(`ÊúçÂä°Âô®ÈîôËØØ: ${response.statusText}`);
            
            appData = await response.json();
            render();
        } catch (error) {
            console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
            alert('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞„ÄÇ');
        }
    }

    async function saveData() {
        const authHeader = getAuthHeader();
        if (!authHeader) {
            requestAuth(saveData);
            return;
        }
        try {
            const response = await fetch('/api/save-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': authHeader },
                body: JSON.stringify(appData)
            });
             if (response.status === 401 || response.status === 403) {
                credentials = null; // Clear bad credentials
                requestAuth(saveData);
                return;
            }
            if (!response.ok) throw new Error(`‰øùÂ≠òÂ§±Ë¥•: ${response.statusText}`);
            console.log('Êï∞ÊçÆÂ∑≤‰øùÂ≠ò!');
        } catch (error) {
            console.error('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', error);
            alert('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞„ÄÇ');
        }
    }

    // --- Rendering ---
    function render() {
        document.title = appData.title || 'ÊàëÁöÑÂØºËà™È°µ';
        pageTitle.textContent = appData.title || 'ÊàëÁöÑÂØºËà™È°µ';

        // Render Links
        linkList.innerHTML = '';
        appData.links.forEach(link => {
            const li = document.createElement('li');
            li.className = 'item';
            li.dataset.id = link.id;
            const faviconUrl = `https://www.google.com/s2/favicons?sz=64&domain_url=${link.url}`;
            li.innerHTML = `
                <img class="icon" src="${faviconUrl}" alt="icon" onerror="this.style.display='none'">
                <a href="${link.url}" target="_blank" rel="noopener noreferrer">${link.name}</a>
                <div class="actions">
                    <button class="delete-btn">‚ùå</button>
                </div>
            `;
            linkList.appendChild(li);
        });

        // Render Clipboard
        clipboardList.innerHTML = '';
        appData.clipboard.forEach(clip => {
            const li = document.createElement('li');
            li.className = 'item';
            li.dataset.id = clip.id;
            li.innerHTML = `
                <span class="icon">üìã</span>
                <span class="clipboard-text">${clip.text}</span>
                <div class="actions">
                    <button class="copy-btn">üìÑ</button>
                    <button class="delete-btn">‚ùå</button>
                </div>
            `;
            clipboardList.appendChild(li);
        });
    }

    // --- Event Handlers ---
    document.getElementById('add-link-form').addEventListener('submit', e => {
        e.preventDefault();
        const nameInput = document.getElementById('link-name');
        const urlInput = document.getElementById('link-url');
        appData.links.push({ id: Date.now().toString(), name: nameInput.value, url: urlInput.value });
        nameInput.value = '';
        urlInput.value = '';
        render();
        saveData();
    });

    document.getElementById('add-clip-form').addEventListener('submit', e => {
        e.preventDefault();
        const textInput = document.getElementById('clip-text');
        appData.clipboard.push({ id: Date.now().toString(), text: textInput.value });
        textInput.value = '';
        render();
        saveData();
    });

    // Delegated event for delete and copy buttons
    document.querySelector('.container').addEventListener('click', e => {
        const target = e.target;
        if (target.classList.contains('delete-btn')) {
            const itemElement = target.closest('.item');
            const id = itemElement.dataset.id;
            const listType = itemElement.parentElement.id === 'link-list' ? 'links' : 'clipboard';
            appData[listType] = appData[listType].filter(item => item.id !== id);
            render();
            saveData();
        }
        if (target.classList.contains('copy-btn')) {
            const textToCopy = target.closest('.item').querySelector('.clipboard-text').textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = target.textContent;
                target.textContent = '‚úÖ';
                setTimeout(() => { target.textContent = originalText; }, 1000);
            });
        }
    });

    // --- Initial Load ---
    loadData();
});
</script>

</body>
</html>
